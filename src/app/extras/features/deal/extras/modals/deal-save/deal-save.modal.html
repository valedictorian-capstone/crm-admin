<nb-card style="position: relative">
    <ngx-spinner [name]="'deal-save'" bdColor="#e5e5e5" [style.opacity]="'0.8'" [zIndex]="999" size="medium" color="#3de2ab" type="ball-clip-rotate-multiple" [fullScreen]="false"></ngx-spinner>
    <nb-card-header style="background: #f7f7f7; border-bottom: 1px solid #e5e5e5">
        {{payload.deal ? 'Edit' : 'New'}} deal
        <button (click)="useClose.emit()" style="float: right" nbButton size="tiny">
      <nb-icon icon="close"></nb-icon>
    </button>
    </nb-card-header>
    <nb-card-body [formGroup]="state.form">
        <span style="display: block; margin-bottom: 0.5rem; font-weight: 600" [class.text-danger]="
    state.form.get('customer').invalid &&
    (state.form.get('customer').touched || state.form.get('customer').dirty)
  ">Customer <span class="text-danger">*</span></span>
        <nb-form-field style="width: 100%; margin-bottom: 1rem">
            <nb-icon icon="person-outline" nbPrefix></nb-icon>
            <input #customerInput fullWidth nz-dropdown [status]="
        state.form.get('customer').invalid &&
        (state.form.get('customer').touched || state.form.get('customer').dirty) ? 'danger' : 'basic'
      " (blur)="state.form.get('customer').markAsTouched()" [nzDropdownMenu]="customerRef" [nzPlacement]="'bottomCenter'" [nzBackdrop]="false" placeholder="Select Customer" [nzTrigger]="'click'" [value]="state.form.get('customer').value?.fullname" nbInput
                size="small" readonly />
            <nb-icon icon="arrow-down" nbSuffix></nb-icon>
        </nb-form-field>
        <nz-dropdown-menu #customerRef="nzDropdownMenu">
            <app-customer-select #customerSelect [control]="state.form.get('customer')"></app-customer-select>
        </nz-dropdown-menu>
        <span *ngIf="state.form.get('customer').invalid && (state.form.get('customer').touched || state.form.get('customer').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please select Customer</span
    >
    <span
      style="display: block; margin-bottom: 0.5rem; font-weight: 600"
      [class.text-danger]="
    state.form.get('title').invalid &&
    (state.form.get('title').touched || state.form.get('title').dirty)
  "
      >Title <span class="text-danger">*</span></span>
        <nb-form-field style="width: 100%; margin-bottom: 1rem">
            <nb-icon icon="donate" pack="font-awesome" nbPrefix></nb-icon>
            <input [status]="
        state.form.get('title').invalid &&
        (state.form.get('title').touched || state.form.get('title').dirty) ? 'danger' : 'basic'
      " fullWidth [formControl]="state.form.get('title')" nbInput size="small" />
        </nb-form-field>
        <span *ngIf="state.form.get('title').invalid && (state.form.get('title').touched || state.form.get('title').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please fill title</span
    >
    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600"
      >Service</span
    >
    <nb-form-field style="max-width: 100%; margin-bottom: 1rem">
      <nb-icon nbPrefix icon="loader-outline"></nb-icon>
      <nb-select
        style="width: 100%"
        fullWidth
        placeholder="Select Service"
        [formControl]="state.form.get('service')"
      >
        <nb-option value="Wedding">Wedding</nb-option>
        <nb-option value="Birthday">Birthday</nb-option>
        <nb-option value="Afternoon Tea">Afternoon Tea</nb-option>
        <nb-option value="Private Dinner">Private Dinner</nb-option>
      </nb-select>
    </nb-form-field>
    <span
      *ngIf="state.canAssign"
      style="display: block; margin-bottom: 0.5rem; font-weight: 600"
      [class.text-danger]="state.form.get('assignee').invalid && (state.form.get('assignee').touched || state.form.get('assignee').dirty)"
      >Owner <span class="text-danger">*</span></span>
        <nb-form-field *ngIf="state.canAssign" style="width: 100%; margin-bottom: 1rem">
            <nb-icon icon="person-outline" nbPrefix></nb-icon>
            <input #assigneeInput fullWidth (blur)="state.form.get('assignee').markAsTouched()" [status]="state.form.get('assignee').invalid && (state.form.get('assignee').touched || state.form.get('assignee').dirty) ? 'danger' : 'basic'" nz-dropdown [nzDropdownMenu]="assigneeRef"
                [nzPlacement]="'bottomCenter'" [nzBackdrop]="false" [nzTrigger]="'click'" [value]="state.form.get('assignee').value?.fullname ? state.form.get('assignee').value.fullname : ''" nbInput size="small" readonly />
            <nb-icon icon="arrow-down" nbSuffix></nb-icon>
        </nb-form-field>
        <nz-dropdown-menu #assigneeRef="nzDropdownMenu">
            <app-employee-select #employeeSelect [control]="state.form.get('assignee')"></app-employee-select>
        </nz-dropdown-menu>
        <span *ngIf="state.form.get('assignee').invalid && (state.form.get('assignee').touched || state.form.get('assignee').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please select owner</span
    >
    <span [style.display]="payload.fix ? 'none' : 'block'" style="display: block; margin-bottom: 0.5rem; font-weight: 600"
      >Process</span
    >
    <nb-form-field [style.display]="payload.fix ? 'none' : 'flex'" style="width: 100%; margin-bottom: 1rem">
      <nb-icon icon="browser-outline" nbPrefix></nb-icon>
      <input
        #pipelineInput
        fullWidth
        nz-dropdown
        [nzDropdownMenu]="pipelineRef"
        [value]="state.form.get('pipeline').value?.name"
        [nzPlacement]="'bottomCenter'"
        [nzBackdrop]="false"
        [nzTrigger]="'click'"
        placeholder="Select process"
        readonly
        nbInput
        size="small"
      />
      <nb-icon icon="arrow-down" nbSuffix></nb-icon>
    </nb-form-field>
    <nz-dropdown-menu #pipelineRef="nzDropdownMenu">
      <app-pipeline-select #pipelineSelect [control]="state.form.get('pipeline')" (modelChange)="useSelectPipeline($event)"></app-pipeline-select>
    </nz-dropdown-menu>
    <span
      *ngIf="state.form.get('pipeline').value"
      style="display: block; margin-bottom: 0.5rem; font-weight: 600"
      >Stage{{state.form.get('stage').value ? ' - ' + state.form.get('stage').value.name : ''}}</span
    >
    <div *ngIf="state.form.get('pipeline').value" class="stages">
      <label
        class="stage"
        (click)="state.form.get('stage').setValue(stage)"
        [class.selected]="
      state.form.get('stage').value &&
      stage.position <= state.form.get('stage').value.position
    "
        *ngFor="let stage of state.form.get('pipeline').value.stages; let i = index"
      ></label>
    </div>
    <nb-form-field
      [style.display]="payload.fix ? 'none' : 'block'"
      style="width: 100%; max-width: 100%; margin-bottom: 1rem; float: left"
    >
      <nb-select
        style="width: 100%; height: 3rem"
        fullWidth
        placeholder="For"
        [formControl]="state.form.get('for')"
      >
        <nb-option value="campaign">For campaign</nb-option>
        <nb-option value="basic">For basic</nb-option>
      </nb-select>
    </nb-form-field>

    <span
      [style.display]="payload.fix ? 'none' : 'block'"
      *ngIf="state.form.get('for').value === 'campaign'"
      style="display: block; margin-bottom: 0.5rem; font-weight: 600"
      [class.text-danger]="state.form.get('campaign').invalid && (state.form.get('campaign').touched || state.form.get('campaign').dirty)"
      >Campaign <span class="text-danger">*</span></span>
        <nb-form-field [style.display]="payload.fix ? 'none' : 'block'" *ngIf="state.form.get('for').value === 'campaign'" style="width: 100%; margin-bottom: 1rem">
            <nb-icon icon="gift-outline" nbPrefix></nb-icon>
            <input #campaignInput fullWidth (blur)="state.form.get('campaign').markAsTouched()" [status]="state.form.get('campaign').invalid && (state.form.get('campaign').touched || state.form.get('campaign').dirty) ? 'danger' : 'basic'" nz-dropdown [nzDropdownMenu]="campaignRef"
                [nzPlacement]="'bottomCenter'" [nzBackdrop]="false" [nzTrigger]="'click'" [value]="state.form.get('campaign').value?.name" nbInput size="small" (input)="campaignSelect.useSearch($event.target.value)" />
            <nb-icon icon="arrow-down" nbSuffix></nb-icon>
        </nb-form-field>
        <span *ngIf="state.form.get('campaign').invalid && (state.form.get('campaign').touched || state.form.get('campaign').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please select campaign</span
    >

    <nz-dropdown-menu #campaignRef="nzDropdownMenu">
      <app-campaign-select #campaignSelect [control]="state.form.get('campaign')"></app-campaign-select>
    </nz-dropdown-menu>
    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600"
      >Description</span
    >
    <nb-form-field style="width: 100%; margin-bottom: 1rem">
      <textarea
        #area
        placeholder="Description"
        fullWidth
        [formControl]="state.form.get('description')"
        (focus)="area.rows = 5"
        rows="1"
        (blur)="area.rows = 1"
        nbInput
      ></textarea>
    </nb-form-field>
  </nb-card-body>
  <nb-card-footer>
    <button
      style="float: right"
      status="default"
      nbButton
      size="small"
      (click)="useDialog(cancelRef)"
    >
      Cancel
    </button>
    <button
      style="float: right; margin-right: 0.5rem"
      [disabled]="state.form.invalid"
      status="primary"
      (click)="useDialog(submitRef)"
      nbButton
      size="small"
    >
      Save
    </button>
  </nb-card-footer>
</nb-card>
<ng-template #submitRef let-data let-ref="dialogRef">
  <nb-card>
    <nb-card-header>Saved changes </nb-card-header>
    <nb-card-body>Are you sure you wish to save and hide modal?</nb-card-body>
    <nb-card-footer class="p-2">
      <button
        style="float: right"
        status="primary"
        nbButton
        size="small"
        (click)="useSubmit(ref)"
      >
        Save and hide
      </button>
      <button
        style="float: right; margin-right: 0.5rem"
        status="default"
        nbButton
        size="small"
        (click)="ref.close()"
      >
        Continue editing
      </button>
    </nb-card-footer>
  </nb-card>
</ng-template>
<ng-template #cancelRef let-data let-ref="dialogRef">
  <nb-card>
    <nb-card-header>You have unsaved changes </nb-card-header>
    <nb-card-body>Are you sure you wish to hide modal?</nb-card-body>
    <nb-card-footer class="p-2">
      <button
        style="float: right"
        status="default"
        nbButton
        size="small"
        (click)="ref.close(); useClose.emit()"
      >
        Hide modal
      </button>
      <button
        style="float: right; margin-right: 0.5rem"
        status="default"
        nbButton
        size="small"
        (click)="ref.close()"
      >
        Continue editing
      </button>
    </nb-card-footer>
  </nb-card>
</ng-template>