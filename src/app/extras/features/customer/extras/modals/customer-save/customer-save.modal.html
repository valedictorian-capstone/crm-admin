<nb-card style="position: relative;" [class.payload.inside]="payload.inside" [class.profile]="payload.isProfile">
    <ngx-spinner *ngIf="!payload.isProfile" [name]="'customer-save'" bdColor="#e5e5e5" [style.opacity]="'0.8'" [zIndex]="999" size="medium" color="#3de2ab" type="ball-clip-rotate-multiple" [fullScreen]="false"></ngx-spinner>
    <nb-card-header *ngIf="!payload.inside && !payload.isProfile" style="background: #f7f7f7; border-bottom: 1px solid #e5e5e5; text-transform: capitalize;">
        {{payload.customer ? 'Edit' : 'New'}} Customer
        <button (click)="useClose.emit()" style="float:right" nbButton size="tiny">
<nb-icon icon="close"></nb-icon>
</button>
    </nb-card-header>
    <nb-card-body [formGroup]="state.form">
        <div class="avatar" *ngIf="!payload.isProfile">
            <div class="avatar-picker" [class.danger]="state.errorImage">
                <input [readOnly]="payload.isProfile" accept="image/jpeg,image/jpg,image/png" (change)="useSelectImage($event, avatarSelect)" #avatarSelect type="file" style="opacity: 0; height: 0; width: 0" />
                <button *ngIf="!state.form.get('avatar').value" nbButton status="default" size="small" (click)="avatarSelect.click()"><nb-icon icon="camera-outline"></nb-icon></button>
                <img *ngIf="state.form.get('avatar').value" [src]="state.form.get('avatar').value" style="width: 80%; height: 80%; border-radius: 50%;" />
                <button *ngIf="state.form.get('avatar').value" style="position: absolute; top: 98px; left: 127px;" shape="round" nbButton [status]="state.errorImage ? 'danger' : 'primary'" size="small" (click)="avatarSelect.click()"><nb-icon icon="camera-outline"></nb-icon></button>
            </div>
            <b *ngIf="state.errorImage" class="text-danger" style="position: absolute; bottom: 5px; text-align: center;">{{state.message}}</b>
        </div>
        <span style="display: block; margin-bottom: 0.5rem; text-transform: capitalize; font-weight: 600;" [class.text-danger]="state.form.get('fullname').invalid && (state.form.get('fullname').touched || state.form.get('fullname').dirty)">Fullname <span class="text-danger">*</span></span>
        <nb-form-field style="width: 100%; margin-bottom: 1rem;">
            <input [readOnly]="payload.isProfile" style="height: 3rem;" [status]="state.form.get('fullname').invalid && (state.form.get('fullname').touched || state.form.get('fullname').dirty) ? 'danger' : 'basic'" fullWidth nz-dropdown [placeholder]="'Fullname'"
                shape="rectangle" [formControl]="state.form.get('fullname')" nbInput size="large" />
            <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('fullname').value)"></nb-icon>
        </nb-form-field>
        <span *ngIf="state.form.get('fullname').invalid && (state.form.get('fullname').touched || state.form.get('fullname').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please fill fullname</span>
        <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;" [class.text-danger]="state.form.get('phone').invalid && (state.form.get('phone').touched || state.form.get('phone').dirty)">Phone <span class="text-danger">*</span></span>
        <nb-form-field class="not-search" [nbSpinner]="state.phoneStage === 'querying'" [nbSpinnerSize]="'tiny'" style="width: 100%; margin-bottom: 1rem;">
            <nb-icon [ngStyle]="{'opacity': state.phoneStage === 'done' ? '1' : '0'}" nbPrefix icon="phone-outline"></nb-icon>
            <input [readOnly]="payload.isProfile" style="height: 3rem;" [status]="state.form.get('phone').invalid && (state.form.get('phone').touched || state.form.get('phone').dirty) ? 'danger' : 'basic'" (blur)="useCheckPhone()" fullWidth nz-dropdown [placeholder]="'Phone'"
                shape="rectangle" [formControl]="state.form.get('phone')" nbInput size="large" />
            <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('phone').value)"></nb-icon>
        </nb-form-field>
        <span *ngIf="(state.form.get('phone').errors?.required || state.form.get('phone').errors?.pattern) && (state.form.get('phone').touched || state.form.get('phone').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please fill correct phone format (Ex: 0902818547)</span>
        <span *ngIf="state.form.get('phone').errors?.duplicate && (state.form.get('phone').touched || state.form.get('phone').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please fill another phone. Because this phone is exsited</span>
        <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;" [class.text-danger]="state.form.get('email').invalid && (state.form.get('email').touched || state.form.get('email').dirty)">Email <span class="text-danger">*</span></span>
        <nb-form-field class="not-search" [nbSpinner]="state.emailStage === 'querying'" [nbSpinnerSize]="'tiny'" style="width: 100%; margin-bottom: 1rem;">
            <nb-icon [ngStyle]="{'opacity': state.emailStage === 'done' ? '1' : '0'}" nbPrefix icon="email-outline"></nb-icon>
            <input [readOnly]="payload.isProfile" style="height: 3rem;" [status]="state.form.get('email').invalid && (state.form.get('email').touched || state.form.get('email').dirty) ? 'danger' : 'basic'" (blur)="useCheckEmail()" fullWidth nz-dropdown [placeholder]="'Email'"
                shape="rectangle" [formControl]="state.form.get('email')" nbInput size="large" />
            <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('email').value)"></nb-icon>
        </nb-form-field>
        <span *ngIf="(state.form.get('email').errors?.required || state.form.get('email').errors?.pattern) && (state.form.get('email').touched || state.form.get('email').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please fill correct email format (Ex: vinhdkse62975@fpt.edu.vn)</span>
        <span *ngIf="state.form.get('email').errors?.duplicate && (state.form.get('email').touched || state.form.get('email').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please fill another email. Because this email is exsited</span>
        <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Gender</span>
        <nb-form-field style="max-width: 100%; margin-bottom: 1rem;">
            <nb-icon nbPrefix icon="transgender" pack="font-awesome"></nb-icon>
            <nb-select style="width: 100%; height: 3rem;" [disabled]="payload.isProfile" fullWidth placeholder="Gender" [formControl]="state.form.get('gender')">
                <nb-option value="-1">-None-</nb-option>
                <nb-option value="0">Male</nb-option>
                <nb-option value="1">Female</nb-option>
                <nb-option value="2">Other</nb-option>
            </nb-select>
        </nb-form-field>
        <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;" [class.text-danger]="state.form.get('birthDay').invalid && (state.form.get('birthDay').touched || state.form.get('birthDay').dirty)">Birthday <span class="text-danger">*</span></span>
        <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
            <nb-icon nbPrefix icon="birthday-cake" pack="font-awesome"></nb-icon>
            <input *ngIf="!payload.isProfile" style="height: 3rem;" readonly fullWidth [status]="state.form.get('birthDay').invalid && (state.form.get('birthDay').touched || state.form.get('birthDay').dirty) ? 'danger' : 'basic'" [value]="state.form.get('birthDay').value | date: 'dd/MM/yyyy'"
                (focus)="state.showBirthday = true" [nzVisible]="state.showBirthday" placeholder="Birthday" nz-dropdown [nzDropdownMenu]="birthDayRef" [nzPlacement]="'bottomCenter'" [nzBackdrop]="false" [nzTrigger]="'click'" nbInput />
            <input *ngIf="payload.isProfile" style="height: 3rem;" readonly fullWidth [status]="state.form.get('birthDay').invalid && (state.form.get('birthDay').touched || state.form.get('birthDay').dirty) ? 'danger' : 'basic'" [value]="state.form.get('birthDay').value | date: 'dd/MM/yyyy'"
                nbInput />
        </nb-form-field>
        <nz-dropdown-menu #birthDayRef="nzDropdownMenu">
            <app-support-date [date]="state.form.get('birthDay').value" [max]="state.max" [min]="state.min" (useChange)="state.form.get('birthDay').setValue($event); state.showBirthday = false"></app-support-date>
        </nz-dropdown-menu>
        <nb-accordion style="width: 100%; margin-bottom: 1rem; float: left;" multi>
            <nb-accordion-item expanded>
                <nb-accordion-item-header>
                    <b class="text-primary">Valuation In Last Month</b>
                </nb-accordion-item-header>
                <nb-accordion-item-body>
                    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;" [class.text-danger]="state.form.get('totalSpending').invalid && (state.form.get('totalSpending').touched || state.form.get('totalSpending').dirty)">Total Spending<span class="text-danger">*</span></span>
                    <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
                        <input [readOnly]="payload.isProfile" fullWidth mask="separator.0" thousandSeparator="," [status]="state.form.get('totalSpending').invalid && (state.form.get('totalSpending').touched || state.form.get('totalSpending').dirty) ? 'danger' : 'basic'" [formControl]="state.form.get('totalSpending')"
                            nbInput />
                        <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('totalSpending').value)"></nb-icon>
                    </nb-form-field>
                    <span *ngIf="state.form.get('totalSpending').invalid && (state.form.get('totalSpending').touched || state.form.get('totalSpending').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please fill total spending</span>
                    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;" [class.text-danger]="state.form.get('totalDeal').invalid && (state.form.get('totalDeal').touched || state.form.get('totalDeal').dirty)">Total Deal <span class="text-danger">*</span></span>
                    <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
                        <input [readOnly]="payload.isProfile" fullWidth mask="separator.0" thousandSeparator="," [status]="state.form.get('totalDeal').invalid && (state.form.get('totalDeal').touched || state.form.get('totalDeal').dirty) ? 'danger' : 'basic'" [formControl]="state.form.get('totalDeal')"
                            nbInput />
                        <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('totalDeal').value)"></nb-icon>
                    </nb-form-field>
                    <span *ngIf="state.form.get('totalDeal').invalid && (state.form.get('totalDeal').touched || state.form.get('totalDeal').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please fill total deal</span>
                    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;" [class.text-danger]="state.form.get('frequency').invalid && (state.form.get('frequency').touched || state.form.get('frequency').dirty)">Total Deal Won <span class="text-danger">*</span></span>
                    <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
                        <input [readOnly]="payload.isProfile" fullWidth mask="separator.0" thousandSeparator="," [status]="state.form.get('frequency').invalid && (state.form.get('frequency').touched || state.form.get('frequency').dirty) ? 'danger' : 'basic'" [formControl]="state.form.get('frequency')"
                            nbInput />
                        <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('frequency').value)"></nb-icon>
                    </nb-form-field>
                    <span *ngIf="state.form.get('frequency').invalid && (state.form.get('frequency').touched || state.form.get('frequency').dirty)" class="text-danger mb-3 display-block font-weight-bold">Please fill total deal won</span>
                </nb-accordion-item-body>
            </nb-accordion-item>
            <nb-accordion-item expanded>
                <nb-accordion-item-header>
                    <b class="text-primary">Social connect</b>
                </nb-accordion-item-header>
                <nb-accordion-item-body>
                    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Skype</span>
                    <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
                        <svg style="width: 20px;" nbPrefix xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><title>Logo Skype</title><path d='M467.16 303.6a205.69 205.69 0 004.9-45.15c0-116.32-95.69-210.7-213.79-210.7a221.83 221.83 0 00-36.52 3A123.58 123.58 0 00155.93 32C87.55 32 32 86.72 32 154.15A119.56 119.56 0 0049 216a211.16 211.16 0 00-4.32 42.35c0 116.44 95.69 210.7 213.67 210.7a214 214 0 0039.09-3.5A125.45 125.45 0 00356.07 480C424.57 480 480 425.28 480 357.85a118 118 0 00-12.84-54.25zM368 359c-9.92 13.76-24.51 24.73-43.41 32.43S283.36 403 257.69 403c-30.69 0-56.36-5.37-76.55-15.87a101 101 0 01-35.24-30.8c-9.11-12.83-13.66-25.66-13.66-38 0-7.7 3-14.35 8.87-19.95 5.84-5.37 13.42-8.17 22.29-8.17 7.35 0 13.65 2.1 18.79 6.42 4.9 4.08 9.1 10.15 12.48 18.08A108.09 108.09 0 00207 336.15q6.32 8.22 17.86 13.65c7.82 3.62 18.2 5.48 31 5.48 17.62 0 32.09-3.73 42.94-11.08 10.74-7.12 15.88-15.75 15.88-26.25 0-8.28-2.69-14.82-8.29-19.95-5.83-5.37-13.42-9.57-22.87-12.37-9.69-3-22.87-6.18-39.21-9.56-22.17-4.67-41-10.27-56-16.57-15.28-6.42-27.65-15.4-36.76-26.48-9.22-11.32-13.77-25.55-13.77-42.24a67.86 67.86 0 0114.47-42.58c9.57-12.25 23.46-21.82 41.55-28.35 17.74-6.53 38.86-9.8 62.66-9.8 19.14 0 35.83 2.22 49.83 6.42s25.91 10.15 35.36 17.38 16.34 14.93 20.77 23 6.66 16.22 6.66 24c0 7.46-2.92 14.35-8.76 20.3a29.65 29.65 0 01-21.94 9.1c-7.93 0-14.12-1.87-18.43-5.6-4-3.5-8.17-8.87-12.72-16.69-5.37-9.91-11.79-17.85-19.14-23.45-7.24-5.36-19.14-8.16-35.71-8.16-15.29 0-27.77 3-37 9-8.87 5.72-13.19 12.37-13.19 20.18a18.26 18.26 0 004.32 12.25 38.13 38.13 0 0012.72 9.57 80.14 90.14 0 0017.15 6.53c6 1.64 15.87 4.09 29.53 7.12 17.38 3.62 33.25 7.82 47.26 12.13 14.24 4.55 26.49 10 36.52 16.45a72.93 72.93 0 0124.16 25.09c5.72 10 8.64 22.63 8.64 37.1A75.09 75.09 0 01368 359z'/></svg>
                        <input [readOnly]="payload.isProfile" fullWidth [formControl]="state.form.get('skypeName')" nbInput />
                        <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('skypeName').value)"></nb-icon>
                    </nb-form-field>
                    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Facebook</span>
                    <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
                        <svg style="width: 20px;" nbPrefix xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><title>Logo Facebook</title><path d='M480 257.35c0-123.7-100.3-224-224-224s-224 100.3-224 224c0 111.8 81.9 204.47 189 221.29V322.12h-56.89v-64.77H221V208c0-56.13 33.45-87.16 84.61-87.16 24.51 0 50.15 4.38 50.15 4.38v55.13H327.5c-27.81 0-36.51 17.26-36.51 35v42h62.12l-9.92 64.77H291v156.54c107.1-16.81 189-109.48 189-221.31z' fill-rule='evenodd'/></svg>
                        <input [readOnly]="payload.isProfile" fullWidth [formControl]="state.form.get('facebook')" nbInput />
                        <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('facebook').value)"></nb-icon>
                    </nb-form-field>
                    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Twitter</span>
                    <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
                        <svg style="width: 20px;" nbPrefix xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><title>Logo Twitter</title><path d='M496 109.5a201.8 201.8 0 01-56.55 15.3 97.51 97.51 0 0043.33-53.6 197.74 197.74 0 01-62.56 23.5A99.14 99.14 0 00348.31 64c-54.42 0-98.46 43.4-98.46 96.9a93.21 93.21 0 002.54 22.1 280.7 280.7 0 01-203-101.3A95.69 95.69 0 0036 130.4c0 33.6 17.53 63.3 44 80.7A97.5 97.5 0 0135.22 199v1.2c0 47 34 86.1 79 95a100.76 100.76 0 01-25.94 3.4 94.38 94.38 0 01-18.51-1.8c12.51 38.5 48.92 66.5 92.05 67.3A199.59 199.59 0 0139.5 405.6a203 203 0 01-23.5-1.4A278.68 278.68 0 00166.74 448c181.36 0 280.44-147.7 280.44-275.8 0-4.2-.11-8.4-.31-12.5A198.48 198.48 0 00496 109.5z'/></svg>
                        <input [readOnly]="payload.isProfile" fullWidth [formControl]="state.form.get('twitter')" nbInput />
                        <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('twitter').value)"></nb-icon>
                    </nb-form-field>
                </nb-accordion-item-body>
            </nb-accordion-item>
            <nb-accordion-item expanded>
                <nb-accordion-item-header>
                    <b class="text-primary">Address</b>
                </nb-accordion-item-header>
                <nb-accordion-item-body>
                    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Street</span>
                    <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
                        <nb-icon nbPrefix icon="pin-outline"></nb-icon>
                        <input [readOnly]="payload.isProfile" fullWidth [formControl]="state.form.get('street')" nbInput />
                        <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('street').value)"></nb-icon>
                    </nb-form-field>
                    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;">City</span>
                    <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
                        <nb-icon nbPrefix icon="city" pack="font-awesome"></nb-icon>
                        <input [readOnly]="payload.isProfile" fullWidth [formControl]="state.form.get('city')" nbInput />
                        <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('city').value)"></nb-icon>
                    </nb-form-field>
                    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;">State</span>
                    <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
                        <nb-icon nbPrefix icon="flag-usa" pack="font-awesome"></nb-icon>
                        <input [readOnly]="payload.isProfile" fullWidth [formControl]="state.form.get('state')" nbInput />
                        <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('state').value)"></nb-icon>
                    </nb-form-field>
                    <span style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Country</span>
                    <nb-form-field style="width: 100%; margin-bottom: 1rem; float: left;">
                        <nb-icon nbPrefix icon="globe-asia" pack="font-awesome"></nb-icon>
                        <input [readOnly]="payload.isProfile" fullWidth [formControl]="state.form.get('country')" nbInput />
                        <nb-icon icon="copy-outline" nbSuffix *ngIf="payload.isProfile" (click)="useCopy(state.form.get('country').value)"></nb-icon>
                    </nb-form-field>
                </nb-accordion-item-body>
            </nb-accordion-item>
        </nb-accordion>
        <nb-form-field style="width: 100%; margin-bottom: 1rem;">
            <textarea [readOnly]="payload.isProfile" #area placeHolder="Description" fullWidth [formControl]="state.form.get('description')" (focus)="area.rows = 5" [rows]="payload.isProfile ? 5 : 2" (blur)="area.rows = 2" nbInput></textarea>
        </nb-form-field>
    </nb-card-body>
    <nb-card-footer *ngIf="!payload.inside && !payload.isProfile">
        <button style="float: right;" status="default" nbButton size="small" (click)="useDialog(cancelRef)">Cancel</button>
        <button style="float: right; margin-right: 0.5rem;" [disabled]="state.form.invalid" status="primary" (click)="useDialog(submitRef)" nbButton size="small">Save</button>
    </nb-card-footer>
</nb-card>
<ng-template #submitRef let-data let-ref="dialogRef">
    <nb-card>
        <nb-card-header>Saved changes
        </nb-card-header>
        <nb-card-body>Are you sure you wish to save and hide modal?</nb-card-body>
        <nb-card-footer class="p-2">
            <button style="float: right;" status="primary" nbButton size="small" (click)="useSubmit(ref)">Save and hide</button>
            <button style="float: right; margin-right: 0.5rem;" status="default" nbButton size="small" (click)="ref.close()">Continue editing</button>
        </nb-card-footer>
    </nb-card>
</ng-template>
<ng-template #cancelRef let-data let-ref="dialogRef">
    <nb-card>
        <nb-card-header>You have unsaved changes
        </nb-card-header>
        <nb-card-body>Are you sure you wish to hide modal?</nb-card-body>
        <nb-card-footer class="p-2">
            <button style="float: right;" status="default" nbButton size="small" (click)="ref.close(); useClose.emit();">Hide modal</button>
            <button style="float: right; margin-right: 0.5rem;" status="default" nbButton size="small" (click)="ref.close()">Continue editing</button>
        </nb-card-footer>
    </nb-card>
</ng-template>